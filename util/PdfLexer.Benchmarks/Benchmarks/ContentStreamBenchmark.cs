using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Diagnosers;
using BenchmarkDotNet.Jobs;
using PdfLexer.Lexing;
using PdfLexer.Operators;
using PdfLexer.Parsers;
using PdfSharp.Pdf.Content;
using PdfSharp.Pdf.Content.Objects;
using System;
using System.Buffers;
using System.Collections.Generic;
using System.IO;
using System.Text;
using UglyToad.PdfPig.Core;
using UglyToad.PdfPig.Tokenization.Scanner;
using UglyToad.PdfPig.Tokens;

namespace PdfLexer.Benchmarks.Benchmarks
{

    [Config(typeof(BenchmarkConfig))]
    public class ContentStreamBenchmark
    {
        public static List<string> data = new List<string>
        {
            @"q
0.24 0 0 0.24 0 0 cm
/R7 gs
0 G
0 g
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 297.441 56.9203 Tm
[(\001) 0.390321(\002)] TJ
/R10 10.08 Tf
1.00074 0 0 1 309.441 56.9203 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 314.481 56.9203 Tm
[(\002) 0.390321(\001)] TJ
ET
Q
q
1360.34 280.168 m
1362.34 280.168 l
1362.34 230.168 l
1360.34 230.168 l
h
W
n
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 326.481 56.9203 Tm
(\002) Tj
ET
Q
Q
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 90.0806 731.32 Tm
[(\003) -19.205(\004) 0.779304(\005) -19.205(\006) -19.2051(\007) -19.205(\b) -19.205(\t) -19.205(\n) 0.779421(\013) -19.205(\f) -19.205(\r) -19.205(\016) -19.205(\016) -19.2051(\017) 0.778202(\002) -519.204(\020) -19.2062(\021) -19.2062(\022) -19.2062(\023) 0.778202(\024) -19.2062(\025) -19.2062(\026) 0.778202(\027) -19.2062(\030) -19.2062(\031) -19.2062(\032) -19.2062(\033) 1000] TJ
ET
Q
q
1746.34 3090.17 m
1771.34 3090.17 l
1771.34 3040.17 l
1746.34 3040.17 l
h
W
n
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 419.121 731.32 Tm
(\002) Tj
ET
Q
Q
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 90.0806 701.08 Tm
[(\003) -19.205(\004) 0.779304(\005) -19.205(\034) -19.2051(\007) -19.205(\005) -19.205(\035) -19.205(\005) 0.779421(\r) -19.2051(\036) -19.205(\002) -519.206(\013) -19.205(\037) -19.2062( ) 0.778202(!) -19.2062("") -19.2062(#) -19.2062($) 0.779304(\002)] TJ
ET
Q
353.336 3128.17 2 2 re
f
353.336 3128.17 2 2 re
f
355.336 3128.17 1416 2 re
f
1771.34 3128.17 2 2 re
f
1771.34 3128.17 2 2 re
f
353.336 2875.17 2 253 re
f
353.336 2873.17 2 2 re
f
353.336 2873.17 2 2 re
f
355.336 2873.17 1416 2 re
f
1771.34 2875.17 2 253 re
f
1771.34 2873.17 2 2 re
f
1771.34 2873.17 2 2 re
f
q
4.16667 0 0 4.16667 0 0 cm
BT
/R8 12 Tf
1.00078 0 0 1 85.0406 670.12 Tm
(\002) Tj
30.24 TL
T*
[(\002) -519.205(\002) -499.221(\002) -519.205(\002) -519.206(\002) -519.206(\002) -519.206(\002) -519.206(\002) -499.221(\002) -519.206(\002) -519.206(\002) -519.204(\002) -519.206(%) -19.205(\002) -499.22(\002) -519.204(\002) -519.204(\002) -519.204(\002) -519.205(&)] TJ
/R12 10.56 Tf
1.0008 0 0 1 316.641 639.88 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 609.64 Tm
[(\002) -519.205(\002) -499.221(\002) -519.205(\002) -519.206(\002) -519.206(\002) -519.206(\002) -519.205(') 0.779421(#) -19.205($) -19.205(\() -19.205(\)) -19.205(*) -19.205(+) 0.778202(,) -19.2051(-) -19.2062(.) -19.2051(/) -19.2062(0) 0.778202(1) -19.2051(2) -19.2062(3) 0.779304(4) -19.2062(5) -19.2062(6) -19.2051(0) -19.2062(1) -19.2051(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 426.321 609.64 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 579.4 Tm
[(\002) -519.205(\002) -499.221(\002) -519.205(\002) -519.206(\002) -519.206(\002) -519.206(\002) -519.205(8) 0.779421(9) -19.2051(:) -19.205(2) -19.205(3) -19.2051(.) -19.205(;) 0.778202(<) -19.2051(=) -19.2062(>) -19.2062(\033) -19.2051(4) 0.778202(?) -19.2062(@) -19.2062(A) 0.778202(B) -19.2062(\027) -19.2062(C) -19.2062(#) -19.2062(D) -19.2051(.) 0.778202(E) -19.2062(F) -19.2062(G) -19.2062(0) -19.2062(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 487.281 579.4 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 549.16 Tm
[(\002) -519.205(\002) -499.221(\002) -519.205(\002) -519.206(\002) -519.206(\002) -519.206(\002) -519.206(\002) -499.221(\002) -519.206(\002) -519.206(\002) -519.204(\002) -519.206(H) -19.205(\002) -499.22(\002) -519.204(\002) -519.204(\002) -519.204(\002) -519.205(I)] TJ
/R12 10.56 Tf
1.0008 0 0 1 316.641 549.16 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 518.92 Tm
[(\002) -519.205(*) 0.779421(+) -19.205(J) -19.205(H) -19.205(,) -19.205(K) -19.205(L) 0.779421(M) -19.205(N) -19.2051(O) -19.205(P) -19.205(:) -19.2051(*) 0.778202(+) -19.2062(\t) -19.2062(H) -19.2062(Q) -19.2062(R) 0.779304(S) -19.2062(H) -19.2062(I) 0.779304(.) -19.2062(;) -19.2062(T) -19.2062(S) 1000] TJ
/R12 10.56 Tf
1.0008 0 0 1 401.841 518.92 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 488.68 Tm
[(\002) -519.205(\f) 0.779421(\002) -519.205(>) -19.205(\033) -19.2051(U) -19.205(=) -19.205(\)) 0.779421(*) -19.205(+) -19.205(,) -19.2051(-) -19.205(V) -19.2051(=) 0.778202(*) -19.2062(+) -19.2062(,) -19.2051(.) -19.2062(W) -19.2062(F) -19.2062(=) -19.2062(\)) 0.778202(*) -19.2062(+) -19.2062(,) -19.2051(-) -19.2062(V) -19.2062(X) 0.778202(Y) -19.2062(Z) -19.2062(Y) -19.2051(D) -19.2062([) -19.2051(F) 0.780641(=) -19.2038(\\) -19.2038(U)] TJ
T*
[(]) -19.205(^) 0.779304(0) -19.205(1) -19.2051(_) -19.205(`) -19.2051(4) -19.205(a) 0.779421(b) -19.205(`) -19.2051(c) -19.205(F) -19.2051(=) -19.205(*) 0.778202(+) -19.2062(,) -19.2051(V) -19.2062(D) -19.2062([) -19.2051(0) -19.2062(1) -19.2051(_) 0.778202(`) -19.2051(4) -19.2062(d) -19.2062(b) -19.2062(`) -19.2051(c) 0.778202(0) -19.2062(1) -19.2051(\022) -19.2062(\023) -19.2062(`) -19.2062(b) 0.780641(\024) -19.2038(\\) -19.2051(U)] TJ
30.48 TL
T*
[(_) -19.205(`) 0.779421(\022) -19.2051(\023) -19.205(\024) -19.2051(:) -19.205(\025) -19.205(\026) 0.779421(\027) -19.2051(4) -19.205(\031) -19.205(e) -19.205(1) -19.2051(\032) 0.778202(f) -19.2051(g) -19.2062(h) -19.2062(1) -19.2051(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 316.641 427.96 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 397.72 Tm
[(\002) -519.205(\005) 0.779421(\002) -519.205(') -19.205(i) -19.2051(:) -19.205(\025) -19.205(j) 0.779304(F) -19.205(k) -19.2051(\032) -19.205(l) -19.205(/) -19.205(m) 0.779304(:) -19.2062(n) -19.2062(a) -19.2051(U) -19.2062(=) 0.778202(o) -19.2062(:) -19.2062(c) 0.778202(p) -19.2062(q) -19.2062(g) -19.2062(h) -19.2062(1) -19.2051(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 426.321 397.72 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 367.48 Tm
[(\002) -519.205(r) 0.389711(s) -19.5947(t) -19.5948(\002) -539.189(u) -19.205(v) -39.1894(w) -19.205(\033) -39.1894(x) -19.205(y) -39.1894(z) -19.205({) -39.1895(\f) -39.1894(|) -19.2062(T) -39.1906(F) -19.2062(\006) -39.1906(:) -19.2051(}) -39.1906(_) -39.1906(`) -19.2051(U) -39.1906(=) -19.2062(~) -39.1895(V) -19.2062(D) -39.1906([) -19.2051(F) -39.1906(=) -39.1906() -19.2062(x) -39.1906(y) -19.2062(z) -39.1906({) -19.2051(\016) -39.1882(:) -39.1895(_)] TJ
30.24 TL
T*
[(`) -19.205(U) 0.779421(=) -19.205() -19.205(\200) -19.2051(:) -19.205(J) -19.205(\201) 0.779421(\202) -19.205(\203) -19.205(b) -19.2051(g) -19.205(h) -19.205(1) 0.779304(\204) -19.2062(V) -19.2062(D) -19.2062([) -19.2051(F) -19.2062(S) -19.2062(T) -19.2062(k) 0.779304(\b) -19.2062(\205) -19.2062(\206) -19.2051(=) -19.2062() -19.2062(x) 0.778202(y) -19.2062(z) -19.2062({) -19.2051(\f) -19.2062(|) -19.2062(T) 0.780641(F) -19.2038(\016) -19.2038(:) 1000] TJ
T*
[(}) -19.205(_) 0.779421(`) -19.2051(4) -19.205(\207) -19.205(\210) -19.205(S) -19.2051(\211) 0.779421(*) -19.205(+) -19.205(,) -19.205(D) -19.205([) -19.205(`) 0.779304(\212) -19.2062(c) -19.2062(T) -19.2062(\213) -19.2051(7) -19.2062(\n) -19.2062(7) -19.2051(*) 0.778202(+) -19.2062(,) -19.2062(D) -19.2062([) -19.2062(`) -19.2051(:) 0.778202(\214) -19.2062(2) -19.2051(g) -19.2062(h) -19.2062(1) -19.2051(\013) 0.780641(\f) -19.2038(i) -19.2038(#) 1000] TJ
T*
[($) -19.205(u) 0.779421(v) -19.205(w) -19.205(\033) -19.205(x) -19.205(y) -19.2051(\b) 0.779421(\214) -19.205(\n) -19.205(z) -19.205({) -19.2051(:) -19.205(}) 0.778202(_) -19.2062(`) -19.2051(\b) -19.2062(\205) -19.2062(\206) -19.2051(\211) -19.2062(>) -19.2062(\033) 0.778202(\022) -19.2062(\021) -19.2051(\212) -19.2062(c) -19.2062(T) -19.2062(\213) 0.779304(7) -19.2062(\n) -19.2051(U) -19.2062(=) -19.2062(\215) -19.2062(\020) 0.779304(\f) -19.2038(\017) -19.2038(\216) 1000] TJ
T*
[(:) -19.205(\217) 0.779421(\023) -19.205(\220) -19.205(\216) -19.2051(.) -19.205(\022) -19.205(\221) 0.779421(1) -19.2051(\022) -19.205(\021) -19.2051(:) -19.205(\214) -19.205(2) 0.779304(g) -19.2062(h) -19.2062(1) -19.2051(7) -19.2062(\222) -19.2062(:) -19.2051(\022) -19.2062(\021) 0.779304(U) -19.2062(=) -19.2062(\223) -19.2062(\224) -19.2051(\034) -19.2062(\034) 0.779304(\007) -19.2062(\225) -19.2051(\226) -19.2062(g) -19.2062(.) -19.2051(=) 0.780641(\)) -19.2038(*) -19.2038(+) 1000] TJ
T*
[(,) -19.205(\227)] TJ
/R14 7.92 Tf
1.0007 0 0 1 109.281 216.28 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 117.681 216.28 Tm
[(\230) 0.779421(\231) -19.205(~) -19.205(.) -19.205(\232) -19.205(q) -19.2051(\233) 0.779421(\234) -19.2051(\235) -19.205(Y) -19.205(k) -19.2051(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 263.841 216.28 Tm
(\001) Tj
/R8 12 Tf
1.00078 0 0 1 85.0406 186.04 Tm
[(\002) -519.205(r) 0.389711(\236) -19.5947(t) -19.5948(\002) -539.189(u) -19.205(v) -39.1894(w) -19.2051(\033) -39.1894(x) -19.205(y) -39.1894(z) -19.205({) -39.1895(\f) -39.1894(:) -19.2051(_) -39.1906(`) -19.2051(.) -39.1906(;) -19.2062(<) -39.1895(=) -39.1906(\223) -19.2062(\224) -39.1895(\034) -19.2062(\r) -39.1895(\007) -19.2062(\f) -39.1906(\f) -19.2051(\035) -39.1906(\005) -39.1906(\036) -19.2062(=) -39.1906(\237) -19.2051(4) -39.1906(\240) -19.2038(\241) -39.1882(\242) -39.1882(\024) 1000] TJ
T*
[(\243) -19.205(c) 0.779421(0) -19.205(1) -19.2051(\240) -19.205(\241) -19.205(\242) -19.205(\024) 0.779304(V) -19.205(\234) -19.205(j) -19.2051(\235) -19.205(Y) -19.2051(=) 0.778202() -19.2062(\035) -19.2051(\f) -19.2062(\244) -19.2051(\036) -19.2062(=) -19.2062(X) -19.2062(:) 0.779304(\245) -19.2062(:) -19.2062(\246) -19.2062(z) -19.2051(V) -19.2062(\235) 0.778202(Y) -19.2051(=) -19.2062(*) -19.2062(+) -19.2062(,) -19.2062(D) 0.780641([) -19.2038(`) -19.2051(.)] TJ
T*
[(;) -19.205(<) 0.779304(=) -19.205(\003) -19.205(\004) -19.2051(\f) -19.205(\244) -19.2051(\007) 0.779421(\247) -19.205(\035) -19.205(\005) -19.205(\034) -19.2051(\036) -19.205(=) 0.778202(\250) -19.2051(4) -19.2062(\240) -19.2062(\241) -19.2062(\242) -19.2062(\024) -19.2062(\243) -19.2051(c) 0.778202(0) -19.2062(1) -19.2051(\240) -19.2062(\241) -19.2062(\242) -19.2062(\024) 0.779304(V) -19.2062(\234) -19.2062(j) -19.2051(\235) -19.2062(Y) -19.2051(=) 0.780641() -19.2038(\036) -19.2051(=)] TJ
T*
[(X) -19.205(:) 0.779304(\245) -19.205(:) -19.205(\246) -19.205(z) -19.2051(V) -19.205(\235) 0.779421(Y) -19.205(k) -19.2051(7)] TJ
/R12 10.56 Tf
1.0008 0 0 1 218.961 95.3203 Tm
(\001) Tj
ET
Q
Q"
        };
        private List<byte[]> samples = new List<byte[]>();
        private List<MemoryStream> mss = new List<MemoryStream>();

        public ContentStreamBenchmark()
        {
            foreach (var item in data)
            {
                samples.Add(Encoding.ASCII.GetBytes(item));
            }
            foreach (var item in samples)
            {
                mss.Add(new MemoryStream(item));
            }
            foreach (var item in samples)
            {
                pigItems.Add(new ByteArrayInputBytes(item));
            }

        }

        private List<PdfDictionary> results = new List<PdfDictionary>(10);
        private List<DictionaryToken> pigResults = new List<DictionaryToken>(10);
        private List<ByteArrayInputBytes> pigItems = new List<ByteArrayInputBytes>();


        [Benchmark()]
        public int PdfLexer()
        {
            int i = 0;
            foreach (var item in samples)
            {
                var scanner = new ContentScanner(new ParsingContext(), item);
                PdfOperatorType nxt;
                while ((nxt = scanner.Peek()) != PdfOperatorType.EOC)
                {
                    var op = scanner.GetCurrentOperation();
                    if (op != null)
                    {
                        i++;
                    }
                    scanner.SkipCurrent();
                }
            }
            //Console.WriteLine(i);
            return i;
        }

        [Benchmark()]
        public int PdfLexerJustScan()
        {
            int i = 0;
            foreach (var item in samples)
            {
                var scanner = new ContentScanner(new ParsingContext(), item);
                PdfOperatorType nxt;
                while ((nxt = scanner.Peek()) != PdfOperatorType.EOC)
                {
                    scanner.SkipCurrent();
                    i += 1;
                }
            }
            //Console.WriteLine(i);
            return i;
        }


        // [Benchmark()]
        // public int PdfSharp()
        // {
        //     int i = 0;
        //     foreach (var item in samples)
        //     {
        //         var parser = new CParser(item);
        //         var content = parser.ReadContent();
        //         i += content.Count;
        //     }
        //     //Console.WriteLine(i);
        //     return i;
        // }

        [Benchmark(Baseline = true)]
        public int PdfPig()
        {
            int i = 0;
            foreach (var item in pigItems)
            {
                item.Seek(0);
                var scanner = new CoreTokenScanner(item);
                while (scanner.MoveNext())
                {
                    if (scanner.CurrentToken != null)
                    {
                        i++;
                    }
                }
            }
            //Console.WriteLine(i);
            return i;
        }



        // [Benchmark()]
        // public List<PdfDictionary> PipeReaderMs()
        // {
        //     results.Clear();
        //     foreach (var ms in mss)
        //     {
        //         ms.Position = 0;
        //         var reader = PipeReader.Create(ms);
        //         results.Add(parser.Parse(reader));
        //     }
        //     return results;
        // }
        // 
        // [Benchmark()]
        // public List<PdfDictionary> PipeReaderMsBatch()
        // {
        //     results.Clear();
        //     allMs.Position = 0;
        //     var reader = PipeReader.Create(allMs);
        //     for (var i = 0; i < 7; i++)
        //     {
        //         results.Add(parser.Parse(reader));
        //     }
        //     return results;
        // }

        // [Benchmark()]
        // public List<PdfDictionary> PipeReaderMsSmallBuffer()
        // {
        //     results.Clear();
        //     foreach (var ms in mss)
        //     {
        //         ms.Position = 0;
        //         var reader = PipeReader.Create(ms, new StreamPipeReaderOptions(bufferSize: 10, minimumReadSize: 5));
        //         results.Add(parser.Parse(reader));
        //     }
        //     return results;
        // }

        // [Benchmark()]
        // public List<PdfDictionary> PipeReaderMsSmallBufferBatch()
        // {
        //     results.Clear();
        //     allMs.Position = 0;
        //     var reader = PipeReader.Create(allMs, new StreamPipeReaderOptions(bufferSize: 10, minimumReadSize: 5));
        //     for (var i = 0; i < 7; i++)
        //     {
        //         results.Add(parser.Parse(reader));
        //     }
        //     return results;
        // }
    }
}
